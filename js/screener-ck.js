/* global d3 */var dd=dd||{};$(document).ready(function(){dd.setup()});dd.get=dd.get||{};dd.make=dd.make||{};dd.draw=dd.draw||{};dd.update=dd.update||{};dd.scale=dd.scale||{};dd.make.scale=dd.make.scale||{};dd.param={mainDiv:"#screener",w:1024,h:768,hopup:{w:350,triangle:120},scale:1,translate:[0,0],charge:-100,rings:3,size:"Market Cap",color:"Change",dist:"rank",distInv:!0,group:"Sector",score:[{name:"Performance (Year)",weight:5},{name:"PEG",weight:4},{name:"Profit Margin",weight:3}],criteria:{"No.":{exclude:!0},Ticker:{isText:!0},Company:{isText:!0},Sector:{isText:!0},Industry:{isText:!0},Country:{isText:!0},Change:{isPercent:!0,color:!0,size:!0},"Market Cap":{multiplier:1e3,size:!0},Price:{multiplier:1,isDollar:!0},Volume:{multiplier:1},"P/E":{isRatio:!0},"Forward P/E":{isRatio:!0},PEG:{isRatio:!0},"P/S":{isRatio:!0},"P/B":{isRatio:!0},"P/Cash":{isRatio:!0},"P/Free Cash Flow":{isRatio:!0},"Dividend Yield":{isPercent:!0},"Payout Ratio":{isPercent:!0},"EPS (ttm)":{isPercent:!0},"EPS growth this year":{isPercent:!0,color:!0},"EPS growth next year":{isPercent:!0,color:!0},"EPS growth past 5 years":{isPercent:!0,color:!0},"EPS growth next 5 years":{isPercent:!0,color:!0},"Sales growth past 5 years":{isPercent:!0,color:!0},"EPS growth quarter over quarter":{isPercent:!0,color:!0},"Sales growth quarter over quarter":{isPercent:!0,color:!0,size:!0},"Shares Outstanding":{multiplier:1e3,size:!0},"Shares Float":{multiplier:1e3},"Insider Ownership":{isPercent:!0},"Insider Transactions":{isPercent:!0},"Institutional Ownership":{isPercent:!0},"Institutional Transactions":{isPercent:!0},"Float Short":{isPercent:!0},"Short Ratio":{isRatio:!0},"Return on Assets":{isPercent:!0},"Return on Equity":{isPercent:!0},"Return on Investment":{isPercent:!0},"Current Ratio":{isRatio:!0},"Quick Ratio":{isRatio:!0},"LT Debt/Equity":{isRatio:!0,invert:!0},"Total Debt/Equity":{isRatio:!0,invert:!0},"Gross Margin":{isPercent:!0},"Operating Margin":{isPercent:!0},"Profit Margin":{isPercent:!0},"Performance (Week)":{isPercent:!0,color:!0},"Performance (Month)":{isPercent:!0,color:!0},"Performance (Quarter)":{isPercent:!0,color:!0},"Performance (Half Year)":{isPercent:!0,color:!0},"Performance (Year)":{isPercent:!0,color:!0},"Performance (YTD)":{isPercent:!0,color:!0},Beta:{isRatio:!0,invert:!0},"Average True Range":{isRatio:!0},"Volatility (Week)":{isPercent:!0,size:!0},"Volatility (Month)":{isPercent:!0,size:!0},"20-Day Simple Moving Average":{isPercent:!0},"50-Day Simple Moving Average":{isPercent:!0},"200-Day Simple Moving Average":{isPercent:!0},"50-Day High":{isPercent:!0},"50-Day Low":{isPercent:!0},"52-Week High":{isPercent:!0},"52-Week Low":{isPercent:!0},"Relative Strength Index (14)":{isRatio:!0},"Change from Open":{isPercent:!0,color:!0},Gap:{isPercent:!0,color:!0},"Analyst Recom":{isRatio:!0,invert:!0},"Average Volume":{multiplier:1e3},"Relative Volume":{isRatio:!0},"Earnings Date":{isDate:!0},fixed:{exclude:!0},index:{exclude:!0},px:{exclude:!0},py:{exclude:!0},weight:{exclude:!0},x:{exclude:!0},y:{exclude:!0},score:{exclude:!0},rank:{exclude:!0}},filters:[{criteria:"P/E",operator:"greater",value:"Forward P/E",isCriteria:!0},{criteria:"Performance (Year)",operator:"greater",value:"Performance (Quarter)",isCriteria:!0},{criteria:"Market Cap",operator:"greater",value:"10,000"}]};dd.setup=function(){dd.get.data()};dd.get.data=function(){d3.csv("data/SP500.csv",function(e){dd.origData=e;dd.data=e;dd.groups=[];$.each(dd.data,function(e,t){$.each(t,function(t,n){if(n){var r=dd.param.criteria[t];r.isPercent&&(dd.data[e][t]=+n.slice(0,-1));r.isRatio&&(dd.data[e][t]=+n);r.multiplier&&(dd.data[e][t]=n*r.multiplier);t==dd.param.group&&$.inArray(n,dd.groups)==-1&&dd.groups.push(n)}else dd.data[e][t]=null})});dd.make.ranges();dd.make.forces();dd.draw.screener()})};dd.positionDrawer=function(){d3.selectAll(".controls").style("left",dd.param.w+"px").style("bottom",window.innerHeight-dd.param.h+"px")};dd.filter=function(){};dd.make.ranges=function(){dd.mm={};dd.score={};$.each(dd.data[0],function(e){var t=dd.param.criteria[e];if(!t.exclude&&!t.isText){dd.mm[e]={};dd.mm[e].min=t.invert?d3.max(dd.data,function(t){return t[e]}):d3.min(dd.data,function(t){return t[e]});dd.mm[e].max=t.invert?d3.min(dd.data,function(t){return t[e]}):d3.max(dd.data,function(t){return t[e]});dd.mm[e].mid=dd.mm[e].min<0&&dd.mm[e].max>0?0:(dd.mm[e].max-dd.mm[e].min)/2;dd.score[e]=d3.scale.pow().domain([dd.mm[e].min,dd.mm[e].max]).range([0,100]).exponent(.5)}});dd.make.scores();dd.make.scale.all()};dd.make.forces=function(){var e={x:dd.param.w/2,y:dd.param.h/2,fixed:!0,exclude:!0};dd.data.splice(0,0,e);var t=[],n=2*Math.PI/dd.groups.length,r=1,i=1,s=dd.param.h+dd.param.charge;dd.groups.sort();$.each(dd.groups,function(e,o){var u=e*n;if(u>270){u-=270;r=-1}else if(u>180){u-=180;r=-1;i=-1}else if(u>90){u-=90;i=-1}var a=dd.param.w/2+Math.sin(u)*s*r,f=dd.param.h/2+Math.cos(u)*s*i;t[e]={x:a,y:f,fixed:!0,exclude:!0};dd.data.splice(0,0,t[e])});var o=[];$.each(dd.data,function(n,r){if(!r.exclude){o.push({source:e,target:r,type:"dist"});o.push({source:t[$.inArray(r[dd.param.group],dd.groups)],target:r,type:"group"})}});dd.force=d3.layout.force().size([dd.param.w,dd.param.h]).nodes(dd.data).links(o).linkDistance(function(e,t){return dd.param.dist=="score"?e.type=="dist"?dd.scale.dist(dd.mm.score.max-e.target[dd.param.dist])+dd.param.charge/2:dd.scale.dist(e.target[dd.param.dist])-dd.param.charge:e.type=="dist"?dd.scale.dist(e.target[dd.param.dist])+dd.param.charge/2:dd.scale.dist(dd.mm.rank.max-e.target[dd.param.dist])-dd.param.charge}).linkStrength(function(e,t){return e.type=="dist"?1:.5}).charge(dd.param.charge).gravity(.01).friction(.55)};dd.make.scale.all=function(){dd.make.scale.size();dd.make.scale.color();dd.make.scale.dist()};dd.make.scale.size=function(){dd.scale.size=d3.scale.pow().domain([dd.mm[dd.param.size].min,dd.mm[dd.param.size].max]).range([5,50]).exponent(.5);dd.scale.text=d3.scale.pow().domain([dd.mm[dd.param.size].min,dd.mm[dd.param.size].max]).range([3,18]).exponent(.5)};dd.make.scale.color=function(){var e=dd.mm[dd.param.color].min,t=dd.mm[dd.param.color].mid,n=dd.mm[dd.param.color].max;dd.scale.color=d3.scale.linear().domain([e,t-e/2+e,t-1e-14,t,n-t/2+t,n]).range(["#901a18","#ac3f3b","#d87c74","#77b259","#2c8333","#1b451f"])};dd.make.scale.dist=function(){dd.scale.dist=d3.scale.pow().domain([dd.mm[dd.param.dist].min,dd.mm[dd.param.dist].max]).range([0,dd.param.h/2]).exponent(.5)};dd.make.scores=function(){var e=[];$.each(dd.data,function(t,n){var r=0,i=0;$.each(dd.param.score,function(e,t){var s=dd.score[t.name](n[t.name])||0;r+=s*t.weight;i+=t.weight});dd.data[t].score=r/i;e.push({ticker:n.Ticker,value:r/i})});dd.mm.score={min:d3.min(dd.data,function(e){return e.score}),max:d3.max(dd.data,function(e){return e.score})};dd.make.rankScore(e)};dd.make.rankScore=function(e){dd.rankings={};e.sort(dd.rankRank);$.each(e,function(e,t){dd.rankings[t.ticker]=e+1});$.each(dd.data,function(e,t){dd.data[e].rank=dd.rankings[t.Ticker]});dd.mm.rank={min:1,max:e.length}};dd.make.ranks=function(){var e=0,t={};dd.rankings={};$.each(dd.param.score,function(n,r){var i=[];e+=r.weight;$.each(dd.data,function(e,t){var n=t[r.name]||0;i.push({ticker:t.Ticker,value:n})});i.sort(dd.rank);$.each(i,function(e,n){t[n.ticker]=t[n.ticker]||0;t[n.ticker]+=(e+1)*r.weight})});var n=[];$.each(t,function(t,r){n.push({ticker:t,value:r/e})});n.sort(dd.rankRank);$.each(n,function(e,t){dd.rankings[t.ticker]=e+1});$.each(dd.data,function(e,t){dd.data[e].rank=dd.rankings[t.Ticker]});dd.mm.rank={min:1,max:n.length}};dd.update.size=function(e){dd.param.size=e.dropVal;dd.make.scale.size();dd.update.circles()};dd.update.color=function(e){dd.param.color=e.dropVal;dd.make.scale.color();dd.update.circles()};dd.update.dist=function(e){e.dropVal&&(dd.param.score[e.name].name=e.dropVal);e.sliderVal&&(dd.param.score[e.name].weight=e.sliderVal);dd.make.scores();dd.make.scale.dist();dd.force.stop();dd.force.nodes(dd.data).linkDistance(function(e,t){return dd.param.dist=="score"?e.type=="dist"?dd.scale.dist(dd.mm.score.max-e.target[dd.param.dist])+dd.param.charge/2:dd.scale.dist(e.target[dd.param.dist])-dd.param.charge:e.type=="dist"?dd.scale.dist(e.target[dd.param.dist])+dd.param.charge/2:dd.scale.dist(dd.mm.rank.max-e.target[dd.param.dist])-dd.param.charge});dd.force.start()};dd.update.circles=function(){dd.circleGroup.selectAll("circle").data(dd.data).transition().duration(1e3).attr("r",function(e,t){return!e.exclude&&e[dd.param.size]?dd.scale.size(e[dd.param.size])*(1/dd.param.scale):0}).style("fill",function(e,t){return e.exclude?"#3366cc":dd.scale.color(e[dd.param.color])});dd.symbolGroup.selectAll("text").data(dd.data).transition().duration(1e3).style("font-size",function(e,t){return e.exclude?0:dd.scale.text(e[dd.param.size])})};dd.update.hopup=function(e){var t=e.d["Relative Volume"]>1.03?" Above Avg.":e.d["Relative Volume"]<.97?" Below Avg.":" Avg. Volume",n=e.d.Change>.1?"009900":e.d.Change<.1?"990000":"666666",r='<div class="snapshot"><div class="name">'+e.d.Company+' <span class="symbol">('+e.d.Ticker+")</div>";r+='<div class="industry">'+e.d.Sector+"</div>";r+='<ul class="quote"><li><div class="label">Last Price</div><div class="data">'+dd.makeDollar(e.d.Price)+"</div></li>";r+='<li><div class="label">Change</div><div class="data" style="color:#'+n+'">'+dd.makePercent(e.d.Change)+"</div></li>";r+='<li><div class="label">Score</div><div class="data">'+d3.round(e.d.score,2)+" / 100</span></div></li>";r+='<li><div class="label">Rank</div><div class="data">'+e.d.rank+" / 500</span></div></li>";r+="</ul></div>";d3.select(".hopup").style("top",e.event.clientY-10+"px").style("left",e.event.clientX+"px").style("display","block");dd.hopup.content.html(r)};dd.draw.screener=function(){dd.draw.circles();dd.draw.hopup();dd.draw.rings();dd.draw.controls();dd.positionDrawer()};dd.draw.controls=function(){dd.controls={}||dd.controls;dd.controls.div=d3.select(dd.param.mainDiv).append("div").attr("class","controls");dd.controls.scores={}||dd.controls.scores;dd.controls.scores.div=dd.controls.div.append("div").attr("class","control-group");dd.controls.scores.div.append("text").attr("class","label").text("Importance");$.each(dd.param.score,function(e,t){dd.controls.scores.slider=[];dd.controls.scores.slider[e]=dd.draw.dropdown({div:dd.controls.scores.div,name:e,param:dd.param.score[e].name,action:dd.update.dist});var n=dd.controls.scores.div.append("div").attr("class","slider");$(n).slider({animate:!0,value:dd.param.score[e].weight,min:1,max:5,range:"min",stop:function(t,n){dd.update.dist({sliderVal:n.value,name:e})}})});dd.controls.div.append("div").attr("class","control-group");dd.controls.div.append("text").attr("class","label").text("Appearance");dd.controls.color=dd.draw.dropdown({div:dd.controls.div,name:"color",param:dd.param.color,action:dd.update.color,label:"Circle Color",paramInclude:"color"});dd.controls.size=dd.draw.dropdown({div:dd.controls.div,name:"size",param:dd.param.size,action:dd.update.size,label:"Circle Size",paramInclude:"size"})};dd.draw.dropdown=function(e){var t=e.div.append("div").attr("class","container");t.append("div").attr("class","label").text(e.label);var n=t.append("div").attr("class","btn-group "),r=n.append("div").attr("class","btn dropdown-toggle").attr("data-toggle","dropdown"),i=r.append("text").text(e.param);r.append("span").attr("class","caret");var s=n.append("ul").attr("class","dropdown-menu").attr("name",e.name);$.each(dd.param.criteria,function(t,n){var r=!1;e.paramInclude&&(n[e.paramInclude]||(r=!0));!n.exclude&&!n.isText&&!r&&s.append("li").append("a").attr("name",t).text(t)});$(n[0]).find("ul.dropdown-menu a").bind("click",function(t){var n=$(t.target).attr("name"),r=n.length>24?n.slice(0,24)+"...":n;i.text(r);e.action({dropVal:n,name:e.name})});return t};dd.draw.hopup=function(){dd.hopup=d3.select(dd.param.mainDiv).append("div").attr("class","hopup");dd.hopup.content=dd.hopup.append("div").attr("class","content").style("width",dd.param.hopup.w+"px")};dd.draw.rings=function(){for(var e=0;e<dd.param.rings;e++)dd.ringGroup.append("svg:circle").attr("class","ring").attr("r",dd.param.h/dd.param.rings/2*(e+1)).attr("cx",dd.param.w/2).attr("cy",dd.param.h/2);dd.rings=dd.ringGroup.selectAll("circle")};dd.draw.circles=function(){var e={};dd.container=d3.select(dd.param.mainDiv).append("svg:svg").attr("width",dd.param.w).attr("height",dd.param.h).attr("class","screen").call(d3.behavior.zoom().on("zoom",e));dd.ringGroup=dd.container.append("svg:g");dd.circleGroup=dd.container.append("svg:g");dd.circles=dd.circleGroup.selectAll("circle").data(dd.data).enter().append("svg:circle").attr("r",function(e){return e.exclude?0:dd.scale.size(e[dd.param.size])*(1/dd.param.scale)}).attr("class","company").attr("name",function(e){return e.Ticker}).style("fill",function(e){return e.exclude?"none":dd.scale.color(e[dd.param.color])}).style("stroke","#111").style("opacity",.9).on("mouseover",function(e){if(!e.exclude){d3.select(this).style("stroke","#ddd").style("stroke-width",2/dd.param.scale);dd.update.hopup({d:e,event:d3.event})}}).on("mouseout",function(e){if(!e.exclude){d3.select(this).style("stroke","#111").style("stroke-width",1/dd.param.scale);d3.select(".hopup").style("display","none")}});dd.symbolGroup=dd.container.append("svg:g");dd.symbols=dd.symbolGroup.selectAll("text").data(dd.data).enter().append("svg:text").attr("class","symbol").text(function(e){return e.Ticker}).style("font-size",function(e){return dd.scale.text(e[dd.param.size])}).style("opacity",function(e){return e.exclude?0:e.score*1.5/100}).attr("text-anchor","middle").on("mouseover",function(e){e.exclude||dd.update.hopup({d:e,event:d3.event})}).on("mouseout",function(){d3.select(this);d3.select(".hopup").style("display","none")});e=function(){dd.param.scale=d3.event.scale;dd.param.translate=d3.event.translate;dd.circles.attr("transform","translate("+dd.param.translate+") scale("+dd.param.scale+")").attr("r",function(e){return e.exclude?0:dd.scale.size(e[dd.param.size])*(1/dd.param.scale)}).style("stroke-width",2/dd.param.scale);dd.rings.attr("transform","translate("+dd.param.translate+") scale("+dd.param.scale+")").style("stroke-width",1/dd.param.scale);dd.symbols.attr("transform","translate("+dd.param.translate+") scale("+dd.param.scale+")")};dd.force.start();dd.force.on("tick",function(){dd.circleGroup.selectAll("circle").attr("cx",function(e){return e.x}).attr("cy",function(e){return e.y});dd.symbolGroup.selectAll("text").attr("x",function(e){return e.x}).attr("y",function(e){return e.y+dd.scale.text(e[dd.param.size])*.4})})};dd.rank=function(e,t){return e.value-t.value};dd.rankRank=function(e,t){return t.value-e.value};